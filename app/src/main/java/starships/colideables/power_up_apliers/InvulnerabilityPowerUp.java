package starships.colideables.power_up_apliers;

import starships.colideables.AbstractPowerUpApplier;
import starships.colideables.PowerUpApplier;
import starships.colideables.Starship;

import java.util.HashSet;
import java.util.Set;

import static starships.Util.Sets.mergeSetWithItem;

public class InvulnerabilityPowerUp extends AbstractPowerUpApplier {

    private final Double duration;
    private final Double timeSinceStart;
    private Integer lives = null;

    public InvulnerabilityPowerUp(Double duration, Double timeSinceStart) {
        this.duration = duration;
        this.timeSinceStart = timeSinceStart;
    }

    public InvulnerabilityPowerUp(Integer lives, Double duration, Double timeSinceStart) {
        this.lives = lives;
        this.duration = duration;
        this.timeSinceStart = timeSinceStart;
    }


    @Override
    public Starship mount(Starship starship) {
        if (lives == null) this.lives = starship.getLives();
        return new Starship(
                starship.getId(),
                starship.getPlayerNumber(),
                mergeSetWithItem(starship.getStarshipPowerUps(), this),
                starship.getMovementData(),
                999,
                starship.getWeapon(),
                starship.getCollisionVisitor(),
                starship.getMover());
    }

    @Override
    public Starship dismount(Starship starship) {
        return new Starship(
                starship.getId(),
                starship.getPlayerNumber(),
                removePowerUp(starship.getStarshipPowerUps()),
                starship.getMovementData(),
                lives,
                starship.getWeapon(),
                starship.getCollisionVisitor(),
                starship.getMover());
    }

    private Set<PowerUpApplier> removePowerUp(Set<PowerUpApplier> starshipPowerUps) {
        Set<PowerUpApplier> newPowerUps = new HashSet<>(starshipPowerUps);
        newPowerUps.remove(this);
        return newPowerUps;
    }

    @Override
    public boolean isOver(Double secondsSinceLastTime) {
        return timeSinceStart + secondsSinceLastTime >= duration;
    }

    @Override
    public PowerUpApplier addTime(Double secondsSinceLastTime) {
        return new InvulnerabilityPowerUp(lives, duration, timeSinceStart + secondsSinceLastTime);
    }
}
